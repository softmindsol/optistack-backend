generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  fullname  String?
  phone     String?
  dob       DateTime?
  
  // Email Verification & Password Reset
  isEmailVerified       Boolean  @default(false)
  emailVerificationOTP  String?
  otpExpiry             DateTime?
  passwordResetOTP      String?
  passwordResetToken    String?
  passwordResetExpiry   DateTime?
  
  // Onboarding / Profile Data
  gender               String?
  height               Float?
  weight               Float?
  healthGoals          String[]
  supplementExperience String?
  appGoals             String[]
  
  // Extended Onboarding
  age                  Int?
  averageSleep         Float?
  dietType             String?
  activityLevel        String?
  caffeineIntake       String? // Kept for backward compatibility, but habits can cover this
  habits               Json?   // Stores array of { type: String, frequency: String }
  medicalConditions    String[]
  currentSupplements   String[]

  dailyCheckIns        DailyCheckIn[]
  stackItems           StackItem[]
  stackLogs            StackLog[]
  journals             Journal[]
  moodLogs             MoodLog[]

  // Subscription
  subscriptionPlan     String   @default("FREE") // "FREE", "PRO"
  subscriptionStatus   String   @default("ACTIVE") // "ACTIVE", "EXPIRED", "CANCELLED"
  subscriptionExpiry   DateTime?
  
  transactions         Transaction[]

  roleId    Int
  role      Role     @relation(fields: [roleId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Transaction {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation(fields: [userId], references: [id])
  
  amount          Float
  currency        String   @default("USD")
  type            String   // "SUBSCRIPTION_PAYMENT", "REFUND"
  status          String   // "PENDING", "COMPLETED", "FAILED"
  paymentMethod   String?  // "CREDIT_CARD", "PAYPAL"
  transactionDate DateTime @default(now())
  
  description     String?  // e.g. "Pro Plan - Monthly"

  @@map("transactions")
}

model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique // e.g., 'ADMIN', 'USER'
  permissions Permission[]
  users       User[]

  @@map("roles")
}

model Permission {
  id    Int    @id @default(autoincrement())
  name  String @unique // e.g., 'READ_USER', 'WRITE_USER'
  roles Role[]

  @@map("permissions")
}

enum TodaysFeeling {
  GREAT
  GOOD
  OKAY
  LOW
  ANGRY
}

enum SideEffect {
  NAUSEA
  ANXIETY
  FATIGUE
  HEADACHE
  JITTERS
  NO_SIDE_EFFECT
}

model DailyCheckIn {
  id                 Int           @id @default(autoincrement())
  todaysFeeling      TodaysFeeling
  didTakeAnythingNew Boolean
  anySideEffect      SideEffect
  sleepLastNight     Int
  sleepQuality       Int
  energyLevel        Int
  focus              Int
  wellnessImpact     String

  userId             Int
  user               User          @relation(fields: [userId], references: [id])

  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt


  @@map("daily_check_ins") 
}

model Product {
  id              Int      @id @default(autoincrement())
  name            String
  category        String   // "Eskstrakty" (Extracts)
  image           String?  // URL to image
  rating          Float?   // 9.5
  ratingLabel     String?  // "Excellent"
  servings        Int?     // 90
  pricePerServing Float?   // 0.44
  totalPrice      Float    // 39
  currency        String   @default("$")
  format          String?  // "Tablets"

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("products")
  stackItems      StackItem[]
}

model StackItem {
  id            Int      @id @default(autoincrement())
  
  userId        Int
  user          User     @relation(fields: [userId], references: [id])
  
  productId     Int
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Health Goal (Image 3)
  healthGoal    String?

  // Schedule (Image 2)
  isDaily       Boolean  @default(true)
  withFood      Boolean  @default(false)
  
  // Doses (Image 2 shows: Morning, Mid-day, Evening, Night)
  morningDose   Int?     @default(0)
  midDayDose    Int?     @default(0)
  eveningDose   Int?     @default(0)
  nightDose     Int?     @default(0)

  aiSuggestion  String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, productId])
  @@map("stack_items")
  stackLogs     StackLog[]
}

model StackLog {
  id          Int       @id @default(autoincrement())
  
  stackItemId Int
  stackItem   StackItem @relation(fields: [stackItemId], references: [id])
  
  userId      Int
  user        User      @relation(fields: [userId], references: [id])
  
  date        DateTime  // The date for this log (e.g. 2025-12-12T00:00:00.000Z)
  timeSlot    String    // "MORNING", "MID_DAY", "EVENING", "NIGHT"
  status      String    @default("COMPLETED") // "COMPLETED", "SKIPPED"

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt


  @@unique([stackItemId, date, timeSlot])
  @@map("stack_logs")
}

model Journal {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  
  date      DateTime @default(now())
  title     String
  dailyNote String   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("journals")
}

model MoodLog {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  
  date        DateTime @default(now())
  todayMode   String   // User didn't specify enum, but implied mood. keeping string for flexibility or we can use existing TodaysFeeling
  energyLevel Int      // 1 to 5
  dailyNote   String?  @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("mood_logs")
}
